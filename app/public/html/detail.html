<html>

<head>
    <title>AbricotD√©pot</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/scss.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>
    <h1>AbricotD√©pot</h1>
    <nav>
        <ul class="menu">
            <li><div class="logo"><img class="logo" src="Image/Logo-sans-fond.png"></div></li>
            <li><div class="home"><img class="icon" src="Image/icones/Home.png"></div></li>
            <li><a href="/connexion"><div class="inscription"><img class="icon" src="Image/icones/User.png"></div></a></li>
        </ul>
    </nav>

    <main class="detaille">

        <div class="articleDetaille">
            <h2>D√©tail du produit</h2>
            <img class="produit-image" src="{{outil_image}}" alt="{{outil_nom}}">
            <div class="produit-info">
                <h3 class="nom">{{outil_nom}}</h3>
                <p class="description">{{outil_description}}</p>
                <p class="prix">Prix : {{outil_prix}} ‚Ç¨</p>
                <p class="categorie">Cat√©gorie : {{outil_categorie}}</p>
            </div>
            <form class="Reservation">
                {{outil_quantite_select}}
            </form>
        </div>


    </main>
</body>

<script>//ajout des logs pour le debug
document.addEventListener('DOMContentLoaded', () => {
    const dateDebutInput = document.getElementById('date_debut');
    const dateFinInput = document.getElementById('date_fin');
    const quantiteSelect = document.getElementById('quantite');
    const outilId = window.location.pathname.split('/').pop(); // r√©cup√®re l'id depuis l'URL

    console.log("üß© Outil ID d√©tect√© :", outilId);

    async function updateQuantiteOptions() {
        const dateDebut = dateDebutInput.value;
        const dateFin = dateFinInput.value;

        console.log("üìÖ Dates s√©lectionn√©es :", { dateDebut, dateFin });

        // On attend que les deux dates soient renseign√©es
        if (!dateDebut || !dateFin) {
            console.log("‚è≥ En attente des deux dates...");
            return;
        }

        try {
            const reservationUrl = `/reservations/${outilId}/${dateDebut}/${dateFin}`;
            const stockUrl = `/outils/${outilId}/stocks`;

            console.log("üîó Requ√™tes API :", { reservationUrl, stockUrl });

            const response = await fetch(reservationUrl);
            const stockage = await fetch(stockUrl);

            console.log("üì° R√©ponses API :", { response, stockage });

                const reservations = await response.json();

            if (!stockage.ok) {
                throw new Error("Erreur lors de la r√©cup√©ration du stock");
            }

            const stockData = await stockage.json();

            console.log("üì¶ Donn√©es re√ßues :", { reservations, stockData });

            // Additionne leurs quantit√©s si plusieurs r√©servations
            let totalReserve = 0;
            if (Array.isArray(reservations)) {
                totalReserve = reservations.reduce((somme, res) => somme + (res.quantity ?? 0), 0);
            } else if (reservations.quantity) {
                totalReserve = reservations.quantity;
            }

            const stockTotal = stockData.quantity ?? 0;
            const maxQuantite = Math.max(stockTotal - totalReserve, 0);

            console.log("üìä Calculs :", {
                stockTotal,
                totalReserve,
                maxQuantite
            });

            // Reconstruction de la combobox
            quantiteSelect.innerHTML = "";

            if (maxQuantite > 0) {
                for (let i = 1; i <= maxQuantite; i++) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.textContent = i;
                    quantiteSelect.appendChild(option);
                }
            } else {
                const option = document.createElement("option");
                option.textContent = "Indisponible";
                option.disabled = true;
                quantiteSelect.appendChild(option);
            }

            console.log("‚úÖ Combobox mise √† jour avec", maxQuantite, "valeurs disponibles.");

        } catch (error) {
            console.error("‚ùå Erreur dans updateQuantiteOptions :", error);
        }
    }

    dateDebutInput.addEventListener("change", updateQuantiteOptions);
    dateFinInput.addEventListener("change", updateQuantiteOptions);
});
</script>